# 考虑点线的关联性

## 从二维观测上找到在线上的点

+ 如果点在线上，点线距离阈值是否可以放大一些？如果点在线以外，距离阈值更小一些，因为在线外，出错的几率会更大一些
+ 点特征，存储的是深度，优化的时候，para里边就是转换成逆深度
+ **经过实际观察，被检测到共线的点线，其世界系下的点线距离，有的很近，但有的距离也会超过一米————这个数据可以在论文里边表现，可以说明这个问题**





+ 消失点检测的地方添加了绝对值符号 d = fabs(num/(nNorm*rNorm));

___________

## 三角化

+ 一条线可能与好几个点匹配上，这些点可能并不共线
  + 优先选择在直线以内的点，否则，就选择距离直线端点最近的点
+ 存在一些离镜头很近，长度不太正常的线，其很可能时消失点提取环节将直线的方向辨识错误导致的
  + 一个措施是，通过直线的重投影误差，直线端点的重投影与实际观测的对比，可以将这种情况识别出来
  + 一般来说，即使这次方向识别有误，那么大多数情况下还是可以识别正确的
  + 目前剔除外点仅通过直线到相机原点的距离与重投影误差，没有参考端点————验证发现，端点看不出来
  + 考虑根据多次结构线的辨识去
+ 发现点线三角化时，加入根据直线的端点去剔除，反倒效果变差        
+ 一个方向的预处理函数，放在三角化以前
  + 根据各帧的观测，选择出现数量最多的作为该直线对应的消失点方向
  + 已经三角化了的，如果发现三角化时的方向与观测最多的消失点方向不一致，则重新三角化
  + 
+ 尝试将将直接三角化所得的方向与S系的坐标轴进行比较，但效果略有变差，1cm左右，还是选择直接与vp在s系的方向对比效果较好
+ 直接三角化先得到方向以后，再根据点进行三角化，可能出现问题的原因是前一步直接三角化所得的结果有问题，直接不再进行后边的操作             rmse	0.190566
+ 基于上一步，加入，如果直接三角化出问题，那么也会直接考虑使用点进行线的三角化       rmse	0.188732   

+ 点线的状态不稳定，一条线可能在三角化以后，才会被认为跟某个点共线，而且这个点不一定稳定，id可能变，也可能不变？————所以说，一条线它可能并不是跟一个点绑定的，可能是id不同的多个
+ 实际发现，本应共线的两个线，并没有共线

+ 

____________



## 如何利用该关联性，约束的建立

### 一个线，一个点——得经过至少一次优化后的确认——在线特征里添加一个信息，表示它跟哪个点是共线的

位置的绑定——点代线？

由一个点的参数，直接得到其绑定的那根线的重投影误差及误差对相关变量的雅克比矩阵

具体的实施步骤，及状态量的管理

+ 一个数据结构，专门描述每一帧图像新三角化的点线绑定情况——

+ 点线经过优化后，再结合直线方向的观测是否稳定，确定下来是否可以建立点线的绑定，在线特征的类里边用一个变量描述其与哪一个点产生了绑定关系————当2d的观测比较充分，则就认为是靠谱的点线绑定

+ 绑定时，优先选择在线上的点？还是观测次数最多的点？

  

+ 在窗口内构建残差项的时候，当发现一条线与一点绑定，则根据相应的点构建残差项，变量是点。——需要一个数据结构，描述点的参数对应的ID ，考虑使用map，可以直接根据id找到那个点的参数变量

+ 优化完成后，根据绑定的点，去更新线的参数

+ 实际检查一下重投影误差，看一下这个模型是否有问题

**实际在边缘化时，将绑定的线加入，效果变得更差**

**尝试等待Rws稳定后，在将与点绑定的线添加到优化中，结果还是会变差**

MH_05得到的0.186的程序跑MH_04, 0.24,**比最开始的变差**

**连着好几次，2d图像的观测上，点线是在一起的，也表示他们是比较靠谱的**

+ 是否在剔除外点删除线的时候，剔除line_on_point_all_frame中的线，有待验证



**在特征之间添加约束，确实会导致H矩阵不再成为一个标准的箭形矩阵**——对求解的影响？



### 一个线，多个点



+ 将所有在线上的点与线添加约束，0.55 归一化方差，<1.5 <1.5 rmse	0.182795
+ 0.5  归一化方差   rmse	0.195476
+ 0. 6归一化方差     rmse	0.191130
+ 0..55    < 2      rmse	0.187379
+ 0.55 < 1  <1  >4  rmse	0.178974
+ 0.55 <0.5, <0.8     rmse	0.184471
+ 0.55 <0.8, <0.8 rmse	0.183955
+ 0.55 <1.2  <1.2    rmse	0.189309
+   point_relaion(1) > 5 0.55 <1 <1  rmse	0.186008
+ 0.55 < 1  <1  >3 rmse	0.195096
+ 在边缘化时，添加点线之间的约束    rmse	0.197768



### 仅将观测到次数最多的点，添加点线约束

+ <1    rmse	0.193141
+ <1.2     rmse	0.189163
+  <1.45  rmse	0.187423







## 线特征合并的地方可以在优化一下 

