_____



http://docs.ros.org/api/visualization_msgs/html/msg/Marker.html

slam 面试问题总结及回答

https://blog.csdn.net/weixin_44580210/article/details/91790044

**只要这段程序有弯弯绕绕的地方，就把这段程序的大意，干啥的，大概的流程写下来，，后边再看的时候，可以很快的想起来**

**C++很多相关的，都是照猫画虎，不知其所以然**

____________

## 结构线的模型

+ 不要利用点去处理线特征，很不靠谱
+ 线的三角化可跳过的部分，可以以后再考虑
+ 要做的是结构化线的模型表示
+ 把三角化后的线距离相机原点的距离由**10改为5，结果变化不大，都为0.045左右**
+ 将待优化线的LINE_MIN_OBS由3改为5，**变成了0.049，误差变大**，因为可优化的线变少了



在s系，当实际三角化出来的线与对应消失点方向的夹角为50~70度，说明三角化很可能有问题，应该倾向于相信消失点探测出来的方向



## 结构线模型建立思路

+ 在 **processImage()** 开始， 得到每一个相机帧的start_frame , 根据消失点的方向得到**Rcs**，

  + 涉及了三个主方向的正交化，Z方向相反于重力，与相机的前进方向最接近的选为X方向，得到Rcs

+ 相机系下三角化的得到的端点转到**start_frame**，得到S系下线的方向（S轴三个轴的其中一个）

+ **直线的S系，是直线三角化时所在帧的Rcs**
+ 判断实际线的方向与所属消失点方向的夹角，
  + 若该夹角接近0或90，则认为直接三角化的结果是比较正确的，选择相信三角化的结果
  + 否则，认为三角化的不可靠，选择相信消失点所属的方
  
+ 根据线在**start_frame**的方向，确定**Rsl**

+ **start_frame**系下线的端点转到{L}系，取两点中点得到（a，b），进而得到theta与逆深度，{L}系线端点的Z由原来的两个端点得到

+ 



______

## 外点的剔除

+ 首先三角化的时候，确保线的端点在可靠的范围内——理论上，端点越近的越准确
+ 

_________

## optimization（）

https://blog.csdn.net/q597967420/article/details/76099443   介绍优化函数的主流程

https://blog.csdn.net/cqrtxwd/article/details/78956227?depth_1-utm_source=distribute.pc_relevant.none-task&utm_source=distribute.pc_relevant.none-task      ceres使用教程  **初级介绍，仅涉及自动求导**

https://blog.csdn.net/HUAJUN998/article/details/76222745    6个系列文章介绍ceres的使用

https://github.com/castiel520/VINS-Mono/upload/master/vins_estimator   中文注释版的程序

http://zhehangt.win/2018/04/24/SLAM/VINS/VINSVIO/   vins优化介绍的

https://blog.csdn.net/hzwwpgmwy/article/details/86490556    参数的介绍 ceres::LocalParameterization





+ 自动求导与计算雅克比的效果差异
+ problem.AddResidualBlock 会自动添加没有添加的待优化的参数



__________

## 后端优化

### 优化环节需要考虑的问题

1. 视觉观测协方差的设置

2. 当把Rcs固定下来以后，还去marge，是不是有问题的？

3. 下面一段，**主要是为了解决窗口内Rwsc出问题的情况，已解决**

   1. Rcs的测量也可能出问题，可能突然出现一帧，Rcs的测量明显不同与其他
   2. 新进的Rcs在9,10帧，优化的时候，先不要用添加这两帧上三角化的线。然后去判断9帧的Rcs是否明显不同于0帧，如果是，再去判断10帧与0帧的Rcs，从而可以判断出9帧的S系到底是一个异常还是确实有了新的曼哈顿世界。异常，则表明9帧的结构化信息有误，将基于9帧三角化的线删除（还是设置为没有三角化，继续在下一帧三角化，仍然保留9帧的观测及该特征）
   3. **实际发现，直接探测出的Rcs最开始是没问题的，但是Rwc在滑窗内优化时，可能出问题，所以会突然间导致一个异常的Rws，个别帧在窗口内优化时，其旋转可能会出现较大的误差，其表现在Rws上，其误差甚至在越来越大**————所以，只是检测新进的9,10帧是不够的，应该不断检测窗口内各帧的Rws
   4. 将线要转到另一个帧下时，那个新帧可能并没有对这个线的观测，(来自于线特征检测遗留的问题)，但是，线的二参数实际上是与该帧的观测没有关系的，有关的只是该帧的Rcs
   5. 发现整个窗口内的好多的Rws会偏掉,原因是0帧就是那个偏掉的帧，所以，在发现其出问题的时候，就因该marge掉

   

   

   1. 优化中添加线的观测，**起始观测帧不应该跳过**
      1. PLVIO在优化时，线是直接表示在世界系下的，所以三角化所在的帧，也可以作为一个观测，
      2. 而我的线是基于三角化所在的帧表示的，该帧的观测与线的三角化所在的帧，是同一个，相当于添加了重复的参数，所以不可以的————可以参考双目的点，使用右目观测
   2. feature_mange.cpp   975行左右的问题
      1. 原因是在转换线的时候，该帧上并没有线的观测，所以导致该问题

   

4. 到底怎么处理Rcs，考虑作为一个观测，观测的话，得考虑协方差

5. 线的优化，

   1. it_per_id.used_num >= LINE_MIN_OBS && it_per_id.start_frame < WINDOW_SIZE - 2 && it_per_id.is_triangulation

      当线的观测次数大于5/3次，且该线的起始观测帧小于8，这样三角化的特征才会被投影到其他观测帧，

      也就是说，8,9,10帧上三角化的线并不会去优化，所以，也暂时不会用到帧上结构化的信息，只是用了该帧上对已经三角化的线的观测，从而被动解算出一些位姿 ，位姿输出用的是最新进窗口的帧————**考虑，当该位姿所受的约束最多的时候，其优化的结果最接近真相？？** ——可以统计一下待优化节点受到的约束个数
      
   2. 为啥会在相机运动所在的平面有那么多的线，，实际上，轨迹周围是没有线的

   

   

   ## 存在某些帧，并不能探测出完整的曼哈顿世界

   1. 能得到两个正交的消失点, 
   2. 

   

   

______

## 后验：先知道的结果，再去造成的探索原因，，，执果索因，，

## 先验：在结果发生以前，猜测原因，先验概率

## 似然：先定下原因，再去猜测结果的概率，，　　执因索果

https://blog.csdn.net/heyijia0327/article/details/53707261　  介绍marge时先验部分得来的文章

https://blog.csdn.net/heyijia0327/article/details/52822104    

https://www.cnblogs.com/feifanrensheng/p/10532918.html  介绍vins边缘化的操作

https://blog.csdn.net/weixin_44580210/article/details/95748091   结合代码更详细的介绍边缘化

+ 当要marge最老帧，该帧上观测到的特征就是要处理的，观测就是约束，与在哪个帧上三角化没有关系，而是哪个帧对该特征有约束（观测），这才是关键

___________

+ 结构化线的优化
+ 先在整体运行一下，看下结果，确保目前的改动没有影响到结果
+ 在onlylineopt里，进行结构化线的优化相关
+ 先能保证单步优化可以进行，在考虑边缘化

## 验证

+ 结构线的重投影模型

  + 将结构线在{L}系下的交点转到下一个观测的相机坐标系，归一化
  + 根据Rcs，得到下一个相机系归一化平面的消失点－**把直线三角化时所在帧的Rcs转到下一个相机系下**
  + 由两点的直线，检查重投影误差

+ 

+ 

  

## 合并Rcs（合并曼哈顿世界）

+ 每一帧直接探测出的曼哈顿世界，转到世界系，朝向变化很小，则合并，做优化的时候，使用**Rws**
+ 另一种思路，每一帧探测出的Rcs进入优化，优化后，再转到世界系合并
+ 将每帧的Rcs转到 W系，验证发现Rws并无明显的误差累积情况，没误差累积，但会有晃动
+ 从现实角度，**直接使用Rws**
+ 不应该在最开始直接合并Rws，会有误差的累计，，旋转或者角度，应该实时算最新的，



1. 在优化的时候，每一帧的Rcs是独立的，相当于每帧都是一个单独的曼哈顿世界，每条线属于其三角化时所在那个帧的{S}系，重投影的时候，是把那个{S}系，投到了其他观测帧，但事实上，所有的S系只有一个的
   1. 按着当前的方案继续做下去的话，得到每一帧优化后的{S}系，
   2. 滑窗，当要marge掉第0帧时，绝大多数情况下，第0帧的{S}系与第1帧的{S}是同一个，当判断是，则将第0帧的线转到1帧，用第一帧的S系，因为两帧的S系朝向是一致的，所以那个在L系上的交点，只有平移的变化，使用两帧间的位移即可得到，（这个可以验证），当这两个帧之间的S系坐标轴差几个90度，则考虑修改直线的Rsl，使其适应新帧的S系，，————**滑窗的时候，合并曼哈顿世界，转到新的曼哈顿的世界下**
   3. 当确实另有新的曼哈顿世界，则帧间的S系确实探测出朝向不一致，（这个情况可以暂后考虑，因为目前不大可能出现）， 意味着0帧的线在1帧已经不属于结构线了，可以删去
   4. Rs0s1到底是使用原值，还是“归一化”？**这里也可有两种做法**
2. 事实上，还是应该考虑使用统一的Rws，去优化Rws
   1. 刚得到一个相机系下的S系，就与之前得到的Rws去判断朝向，如果朝向基本一致，则直接使用Rws，然后再去三角化，
   2. 有个问题，初始化过后，不再通过pnp计算位姿初值，直接使用上帧的位姿作为当前帧的位姿？或者是imu预积分得到的结果？
   3. 那么Rws的判断咋整？一般来说，帧间的角度变化会有多大？影响会有多大？可能帧间的旋转变化不大，可能也没啥影响



## Rws在整个窗口的偏移

**真实的Rws应该是固定的一个，但实际发现，滑动窗口内的Rws是在上下晃动的（不是累计偏移），因为探测的Rcs？还是Rwc？？，**



## 确实存在某些帧可能并不会观测到一个标准的曼哈顿世界

+ 对这样的帧，这个帧值作为一个被动的观测帧，不在这个帧上三角化



________

 https://blog.csdn.net/qfikh/article/details/103102216    **向量求导相关**

__________

https://blog.csdn.net/qq_43525734/article/details/90294951   涉及协方差矩阵，马氏距离的描述

________

## ideal   每一帧的Rcs，相当于对世界系下结构化场景的观测，各帧之间的Rcs也可以考虑建立观测约束，因为真实的{S}系的方向是唯一的，从而也可以对相机的旋转进行约束优化，

_________

## 相邻帧间的曼哈顿世界为何会有这么大的角度差异

### 原因是在窗口内不断优化的过程中，某些帧的位姿可能会发生变化产生较大的误差。同时可以发现，输出的位姿，是窗口内最新的那个帧，PS[10]，说明最新进的那个，在优化后是比较准的？

但是，最新进的帧，只是作为被动观测帧，其上三角化的特征并未进入优化，所以，问题处在三角化？实际发现，容易出错的帧，在窗口比较靠后的位置？



_____

## 利用点线特征建立八叉树地图

_____

## marge掉的线的发送也有问题

重复发送，暂时解决

_______

## 线特征的提取及合并问题



window