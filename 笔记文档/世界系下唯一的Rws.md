## 优化

1. 因为联合优化前，要不要单独优化线，优化过程中要不要固定相关的参数，应该实验检验，以确定最佳的效果

2. 结构线的立体参数直接基于世界系，与观测帧无任何关联，所以，无需再讨论线是在那个帧上三角化的————优化时不需要考虑三角化所在的帧

3. 但外点拒绝时，判断线的端点，则需要考虑三角化所在的帧————考虑，实则不应通过端点去筛选线，因为线的端点本身不是很可靠，只是用来做可视化显示————结构线的外点拒绝，仅考虑最大重投影误差

4. 暂时不限制优化时间

5. **当仅含线特征的优化中，不固定位姿，在后续的联合优化中，Rws会有较大的差异**————原因是第一步几乎把线都当做外点剔除了

6. 还是发现，一直去优化Rws，是有问题的，————还是发现，是可以一直去优化Rws的，**但是在vector2double时，要rot_diff ***
   
   1. 42.9534  0.187223 -0.904085  先使用不含线的优化后，固定位姿，仅优化线，得到的Rws
   2.  42.6898   0.305907 -0.685848  直接联合优化得到的Rws
   3.  42.9007  0.219426 -0.986201    先固定位姿仅优化线，再联合优化得到的Rws
   4.   多次优化以后的稳定值  46.5969  0.898846 -0.895443
   
   
   
7. 原本PLvio中，优化时，线是基于世界系下的，

8. 发现，初始优化得到的Rws固定后，再次进行优化时，发现，窗口内绝大部分的线都被当做外点删除掉了





## 因为线的二参数时基于S系的，所以优化后，Rws调整后，线的参数是不用管的，要管的是要将基于世界系下的变量旋转回来





## 从更长的距离来看，120s，使用统一的Rws(仅优化一次得到的)，平移与旋转误差均好于每一步都优化optRws, 统一的Rws设置为不同的航向角，结果没多大变化? 可以再试几个？？







## 面临一个问题：最小化重投影误差，到底要不要将Rws作为优化变量——探究Rws对最小化冲投影的影响

1. 做完第一次的onlyStructuralLineOpt后，可以依据不同Rws，看一下冲投影的效果，从而检验Rws对线特征重投影的影响————推断出，最小化重投影误差，不适合将Rws作为优化变量





## 如果，重投影误差不宜将Rws作为优化变量，那又咋整？Rws是否还有其他的优化途径





## 1.两步优化，第一步不固定位姿

1. 第一步前后Rws几乎没变（<1度），各帧的角度变化1~2度之间，平移变化，1cm左右
2. 第二步联合优化，相对于最初值（第一步以前），Rws发生较大变化(>20度)，各帧的位姿，平移几乎没变（几个个毫米），帧的角度变化较大，最大的接近10度

##　2.第一步固定位姿，加外点剔除

1. 第一步前后Rws，1~2度的变化

2. 第二步的Rws有2~3度的变化，相机的平移部分几乎没变，旋转与第一步不固定位姿优化下来的接近

   

## 3.一步直接进行联合优化

发现，Rws、相机的位姿与第一步位姿固定时优化下来的结果接近，优化优化后的线也基本与第一步位姿固定时的接近



**总体来说，2与3的结果很是接近 。2的联合优化的最终误差1.701531e+03 小于直接联合优化的结果   2.186018e+03 **

**通过对比catkin_ws_3， 还是发现两步优化的结果好于直接一步的联合优化**



## 观察了Rws对重投影的影响

只有窗口内三个方向上线的数量都比较充分时，才能对Rws有一个充分的约束。举个例子，假如说Z方向的线数量较少，Rws的偏航角（绕Z轴）对重投影误差的影响可能就没那么大，所以存在约束不足的情况



## 综合下来，有3中方式

1. 两步优化，第一步固定位姿
2. 两步+不剔除外点
3. 直接进行联合优化
4. 固定位姿且不剔除外点与直接优化的结果接近



______

## 边缘化

整个边缘化流程，其实要做的改动只是

1. 当marge_old , 先验信息添加与0帧相关的线的观测
2.   addr_shift[reinterpret_cast<long>(para_Rws[0])] = para_Rws[0]  ——**保留下来的参数变量在下一次优化时的位置 ，**先验部分参数块状态量的管理，涉及的参数



其他的，看起来都是统一的框架，与具体的残差函数无关，不涉及改动，premarginlize()  and marginlize()与具体的形态都没有关系，不用改

_____

## 滑窗

1. 即使在之前的做法中，三角化的线在从一个帧转到另一个帧时，并没有根据新帧上的观测对线的端点做调整，只是将旧帧上的端点转到了新帧上而已————所以，优化后，通过在相机系下的端点的Z是否 小于0，筛选外点，是不靠谱的———除此以外，端点只起一个显示的作用，去维护更新，用处不大
2. 





______

## 问题

1. 使用的统一的Rws，但是最新帧的Rwc不一定很准，所以，将最新帧的观测的Rcs转到世界系下Rws_obs,可能就与当前的Rws有较大差异————所以，最新帧在优化前，只作为被动的观测帧，（即使在最新帧上三角化的特征，也不会进入优化框架），优化后，再去判断Rws_obs，再三角化？
2. 每一帧的Rcs相当于相机系下直线的方向，





_______

## 线特征消失点检测时，可能只提取出两组消失点

+ 线特征提取部分做的改动，导致又同一帧又出现id相同的线？



____

## 差异

1. 所有的线特征是基于一个统一的结构化场景，原点与世界系相重合，而皱的是线基于局部S系，



__________

# MH_04_diffcult的测试

1. 剔除外点，相机系下的直线距离相机原点的距离为10，导致大量的线被剔除
2. 修改为相机系下的直线距离相机原点的距离为20， const int LINE_MIN_OBS = 4  ，rmse	0.214928
3. 



_________

运行一定时间后，再考虑将线特征结合进去？刚开始，线特征并不充分！

+ frame_count  为0时，Rcs出问题，会得到错误的Rws的初值，所以在得到Rws的初值时，判断Rws_state，直接由Rws.empty()判断
+ 当进入的线的帧数不到10帧时，仅marge_old  

___________

## 初步的结果

|       | 跳过开头     |                                                      | 从头开始的 | 始终不固定Rws     稳定后固定Rws   |
| ----- | ------------ | ---------------------------------------------------- | ---------- | --------------------------------- |
|       | vins         | my                               后续修改后的结果    | vins       | my                                |
| MH_01 | 0.194        | **0.130**                               **0.119871** | **0.1606** | 0.166481           **0.114801**   |
| MH_02 | 0.281        | **0.237874**                         **0.165644**    | **0.142**  | 0.153                 0.152530    |
| MH_03 | 0.1297       | **0.102620**                         **0.088985**    | 0.1605     | **0.139584**           0.284753   |
| MH_04 | 0.306        | **0.215**                               **0.189553** | **0.228**  | 0.231510               0.288445   |
| MH_05 | **0.203564** | 0.229724  	                   **0.176**           | 0.335      | **0.210849**             0.249716 |

if_use_line  开始添加线以后，那块的运行跟直接使用线的差别？？









## 调试说明

## MH_03

当稳定后**固定Rws时，加上直方图均衡化，使用固定1.5个像素单位的线特征权重效**果最好

将点线之间的距离约束添加到优化中，初始0.55归一化点线距离误差，改成0.5, 减小了0.003，**最终改为0.14，** 

将判断为共线点线的，仅考虑点线距离<1.5的，得到其均值在0.15左右，最终选择0.14用来归一化点线距离误差

识别共线点线的参数为，**4.5, 4.4， 125.0** 

 **rmse	0.088985**

**尝试了下，将Rws从最开始就直接固定住，rmse	0.145958——所以，Rws还是应该去被优化的？**

将之前调试好的程序，改为从头开始，  rmse	0.396768





直接添加estimate_td: 1   ，rmse	0.110653

____________

## MH_04

直接使用MH_03调整的程序，rmse	0.197480

去掉直方图均衡化  ，   rmse	0.251077

加上直方图均衡化，动态调整线特征权重    rmse	0.742566

点线距离权重为0.174   rmse	0.241225

点线距离权重为0.16    rmse	0.208385

直线外端点距离判断的阈值为 120,     rmse	0.192247

继承上面的，其他的都不变，始终不固定Rws   rmse	0.208709

继承 ，固定Rws，识别共线点线的参数为4.5， 4.4，120 ， 不使用点来进行线的三角化，但仍然添加点线距离约束0.15       rmse	0.189553



**尝试将Rws直接固定，   rmse	0.366709**

_________

## MH_05

直接使用MH_04调整的程序，   rmse	0.665254

添加回通过点进行线的三角化     rmse	0.282231

修改line_point_distance_constrain（rmse 0.176 ） ， 4, 4, 120      rmse	0.182748————动态调整线特征权重的，不使用直方图均衡化的

 点线距离误差的权重从0.5修改为 0.254      rmse	0.185801

点线距离误差的权重从0.254修改为 0.2         rmse	0.178451

继承上，修改判断共线点线的点线距离为4.5, 4.5 ， rmse	0.187240

_________

## MH_02

直接使用MH_05的performence_MH_05， rmse	0.517594

直接使用best_performence_MH_04        rmse	0.273932

直接使用best_performence_MH_03        rmse	0.282662

**基于MH_03,设置点线权重为 0.2638, 仅添加点线距离约束，不使用点对直线三角化           rmse	0.165644**

继承上，继续添加通过点三角化部分直线       rmse	0.262090

继承rmse	0.165644   ，去掉直方图均衡化， rmse	0.256726

如果加入动态调整线特征权重，运行会出错的

继承rmse	0.165644  ， 设置点线权重为0.25   rmse	0.172686

继承rmse	0.165644  ， 设置线特征误差权重为1.4个像素， rmse	0.188309

____________

## MH_01

直接使用MH_02调整的程序     rmse	0.157998

不添加点线距离约束，不使用点去三角化直线，1.5个像素的线特征权重，**仅在联合优化中直线剔除外点       rmse	0.119871**

**基于  rmse	0.119871  ，将点线距离约束添加，取0.2468的归一化误差            rmse	0.120586———测试发现，还真就非0.2468不可，其他都会变差**

 基于0.120,外点剔除时，直线与相机原点的距离阈值 if(distance > 25)        rmse	0.159174

基于0.120 ，关闭直方图均衡化        rmse	0.157487

   基于  rmse	0.119871  ，将点线距离约束添加，取0.25的归一化误差           rmse	0.128241

继续改动 ， 使用点去三角化直线     rmse	0.134429





______________

## 一个线特征的生命周期过短

