## 优化

1. 因为联合优化前，要不要单独优化线，优化过程中要不要固定相关的参数，应该实验检验，以确定最佳的效果

2. 结构线的立体参数直接基于世界系，与观测帧无任何关联，所以，无需再讨论线是在那个帧上三角化的————优化时不需要考虑三角化所在的帧

3. 但外点拒绝时，判断线的端点，则需要考虑三角化所在的帧————考虑，实则不应通过端点去筛选线，因为线的端点本身不是很可靠，只是用来做可视化显示————结构线的外点拒绝，仅考虑最大重投影误差

4. 暂时不限制优化时间

5. **当仅含线特征的优化中，不固定位姿，在后续的联合优化中，Rws会有较大的差异**————原因是第一步几乎把线都当做外点剔除了

6. 还是发现，一直去优化Rws，是有问题的，————还是发现，是可以一直去优化Rws的，**但是在vector2double时，要rot_diff ***
   
   1. 42.9534  0.187223 -0.904085  先使用不含线的优化后，固定位姿，仅优化线，得到的Rws
   2.  42.6898   0.305907 -0.685848  直接联合优化得到的Rws
   3.  42.9007  0.219426 -0.986201    先固定位姿仅优化线，再联合优化得到的Rws
   4.   多次优化以后的稳定值  46.5969  0.898846 -0.895443
   
   
   
7. 原本PLvio中，优化时，线是基于世界系下的，

8. 发现，初始优化得到的Rws固定后，再次进行优化时，发现，窗口内绝大部分的线都被当做外点删除掉了





## 因为线的二参数时基于S系的，所以优化后，Rws调整后，线的参数是不用管的，要管的是要将基于世界系下的变量旋转回来





## 从更长的距离来看，120s，使用统一的Rws(仅优化一次得到的)，平移与旋转误差均好于每一步都优化optRws, 统一的Rws设置为不同的航向角，结果没多大变化? 可以再试几个？？







## 面临一个问题：最小化重投影误差，到底要不要将Rws作为优化变量——探究Rws对最小化冲投影的影响

1. 做完第一次的onlyStructuralLineOpt后，可以依据不同Rws，看一下冲投影的效果，从而检验Rws对线特征重投影的影响————推断出，最小化重投影误差，不适合将Rws作为优化变量





## 如果，重投影误差不宜将Rws作为优化变量，那又咋整？Rws是否还有其他的优化途径





## 1.两步优化，第一步不固定位姿

1. 第一步前后Rws几乎没变（<1度），各帧的角度变化1~2度之间，平移变化，1cm左右
2. 第二步联合优化，相对于最初值（第一步以前），Rws发生较大变化(>20度)，各帧的位姿，平移几乎没变（几个个毫米），帧的角度变化较大，最大的接近10度

##　2.第一步固定位姿，加外点剔除

1. 第一步前后Rws，1~2度的变化

2. 第二步的Rws有2~3度的变化，相机的平移部分几乎没变，旋转与第一步不固定位姿优化下来的接近

   

## 3.一步直接进行联合优化

发现，Rws、相机的位姿与第一步位姿固定时优化下来的结果接近，优化优化后的线也基本与第一步位姿固定时的接近



**总体来说，2与3的结果很是接近 。2的联合优化的最终误差1.701531e+03 小于直接联合优化的结果   2.186018e+03 **

**通过对比catkin_ws_3， 还是发现两步优化的结果好于直接一步的联合优化**



## 观察了Rws对重投影的影响

只有窗口内三个方向上线的数量都比较充分时，才能对Rws有一个充分的约束。举个例子，假如说Z方向的线数量较少，Rws的偏航角（绕Z轴）对重投影误差的影响可能就没那么大，所以存在约束不足的情况



## 综合下来，有3中方式

1. 两步优化，第一步固定位姿
2. 两步+不剔除外点
3. 直接进行联合优化
4. 固定位姿且不剔除外点与直接优化的结果接近



______

## 边缘化

整个边缘化流程，其实要做的改动只是

1. 当marge_old , 先验信息添加与0帧相关的线的观测
2.   addr_shift[reinterpret_cast<long>(para_Rws[0])] = para_Rws[0]   ，先验部分参数块状态量的管理，涉及的参数

其他的，看起来都是统一的框架，与具体的残差函数无关，不涉及改动

_____

## 滑窗

1. 即使在之前的做法中，三角化的线在从一个帧转到另一个帧时，并没有根据新帧上的观测对线的端点做调整，只是将旧帧上的端点转到了新帧上而已————所以，优化后，通过在相机系下的端点的Z是否 小于0，筛选外点，是不靠谱的———除此以外，端点只起一个显示的作用，去维护更新，用处不大
2. 





______

## 问题

1. 使用的统一的Rws，但是最新帧的Rwc不一定很准，所以，将最新帧的观测的Rcs转到世界系下Rws_obs,可能就与当前的Rws有较大差异————所以，最新帧在优化前，只作为被动的观测帧，（即使在最新帧上三角化的特征，也不会进入优化框架），优化后，再去判断Rws_obs，再三角化？
2. 每一帧的Rcs相当于相机系下直线的方向，





_______

## 线特征消失点检测时，可能只提取出两组消失点

+ 线特征提取部分做的改动，导致又同一帧又出现id相同的线？



____

## 差异

1. 所有的线特征是基于一个统一的结构化场景，原点与世界系相重合，而皱的是线基于局部S系，



__________

# MH_04_diffcult的测试

1. 剔除外点，相机系下的直线距离相机原点的距离为10，导致大量的线被剔除
2. 修改为相机系下的直线距离相机原点的距离为20， const int LINE_MIN_OBS = 4  ，rmse	0.214928
3. 



_________

运行一定时间后，再考虑将线特征结合进去？刚开始，线特征并不充分！

+ frame_count  为0时，Rcs出问题，会得到错误的Rws的初值，所以在得到Rws的初值时，判断Rws_state，直接由Rws.empty()判断
+ 当进入的线的帧数不到10帧时，仅marge_old  

___________

## 初步的结果

|       | 跳过开头     |                                      | 从头开始的 | 始终不固定Rws     稳定后固定Rws   |
| ----- | ------------ | ------------------------------------ | ---------- | --------------------------------- |
|       | vins         | my                                   | vins       | my                                |
| MH_01 | 0.194        | **0.130**                            | **0.1606** | 0.166481           **0.114801**   |
| MH_02 | 0.281        | **0.237874**                         | **0.142**  | 0.153                 0.152530    |
| MH_03 | 0.1297       | **0.102620**                         | 0.1605     | **0.139584**           0.284753   |
| MH_04 | 0.306        | **0.215**        **0.198123**        | **0.228**  | 0.231510               0.288445   |
| MH_05 | **0.203564** | 0.229724  	**0.199536**     0.186 | 0.335      | **0.210849**             0.249716 |



