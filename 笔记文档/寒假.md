# 分清主次，条理清晰，避免陷入细节的纠缠

________

+ 考虑看懂优化部分的代码，onlylineopt()   , 点线联合**优化**，optimaztionwithline（） 

+ slideWindow();      f_manager.removeFailures();

+ 线特征的提取及改进  双目线特征 目　　以及将消失点融合进去

+ vinsfusion的优化及滑窗  optimaztion（） slidwindow（）  

+ 双目中没有用预计分预测位资，pnp求解的初值为上一帧的Rs，Ps，预积分仅产生imu观测误差？？？

+ 线特征匹配算法的对比，knnmatch与match，————————**局部改进**

+ 即使图像长时间不动，，提取的线特征的ID会不断增加——————**考虑线特征的合并**，**合并考虑实际空间位置**

+ 相机的参数设置部分跳过了，先特征探测函数中，右目相机用的左目的参数，——————**相机内参设置**，**畸变矫正细节被跳过**
  + pinhole模型与mei模型
  + https://blog.csdn.net/okasy/article/details/90665534  相机模型总结的文章
  + 畸变矫正具体的实现  ,remap() 函数的实现原理？？
  + 在数据集的相机参数中，**左右相机内参的差别不大**，所以，暂时，右目参数用的左目的
  
+ **相机内参矩阵，矫正矩阵，，矫正后再用内参矩阵吧？？**   相机的内参及矫正

+ `双目的立体矫正

+ canny+hough 提取直线的时间为50～30ms，，lsd为260～150ms，，lsd准确率高，，， msac.multipleVPEstimation（）仅用时6ms，**时间的消耗出现在线的提取上, LBD 耗时50ms**

+ 当跟踪上的线特征数量少于50, 则将全部的线特征发送，，，若跟踪上的多于50,则仅发送跟踪的先特征 ，51都有可能，**此做法是否带来问题？？**
  + 消失点的检测？？————**发送的线有突变**
    1. 仅用全部的线提取VP，再从发送的线中筛选初结构线
    2. 从发送的线提取消失点，直接得到结构线
    3. **改为全部发送**
  
+ **消失点曼哈顿世界的探测**－－－－－－－基本完成
  
  + RANSAC中，迭代次数的确定
  + **后续可以考虑的改进**
    + 降低时间成本，尽量少算——————结合imu, 识别重力方向，直接剔除垂直线，再提取水平方向消失点，是否可以只提取一个方向，从而推出其他两个，，，，　主要参考文献W74
  
    + 检测阈值，迭代的次数，最小二乘估计的细节
  
    + 同一条线，不一定每次都能被检测为结构线，但几次以内，总能被检测出来，————**涉及线的合并**
  
    + 仍存**在极个别的错检测**————结合实际三角化判断
  
      + **错误检测的线，其必然为 x, 或Ｙ方向的一个，，可结合三角化时直接判断出来**
  
+ **存在误匹配**——————当前帧的多条线与上一帧的一条线匹配上，当**前帧有多个id相同的线**，左右匹配也可能出现类似情况
  
+ **双目匹配的匹配率还是有些低，再经过结构化线的筛选，剩余的右目观测的线甚少**
  
  + **改进**————右目的线按结构化分类，与同类别的左目去匹配，适当提高匹配阈值，增加匹配数量
  
+ **对一帧图像中，出现多条id相同的线的处理**—————使用map
  
  + 如果出现在同一个消失点组，则会出现两个左目观测，直接continue
  + 如果在不同的消失点组，则一个id的linefeature会有多个观测，检测当前的frame_count与最后一次观测所在的frame_count是否一致，若一致，则为一帧同id的多条线，舍弃之
  
+ 线的双目三角化，错误是存在的，该次观测是错的，考虑用后续的观测继三角化？ ，，，**系统对错误观测的容忍**
  
  + 右目相机的矫正——————有关相机图像的细节
  + **双目线三角化出错**
    + 存在端点坐标为0.01级别，厘米级——过于近的
    + 线的双目三角化不是很靠谱？？————很可能来自于相机内参的设定
  
+ **记录特征三角化所在的帧，为的应该是其3d位置**
  
  + 当该帧被marg掉的时候，其对应的特征位置应该做转移
  + 原程序对基于深度表示的点，未做转移——————但此类点并不多
  
+ **应该从根本上解决同一帧出现id相同线的情况**
  
+ **坐标系的对齐**
  
+ 双目线的三角化还是有问题的
  
+ 不要试图用观测的点去处理线特征，很不靠谱
  
+ https://github.com/Jichao-Peng/VINS-Mono-Optimization   **另一个将线特征融入vins的工作**
  
+ onlylineopt()  函数，**协方差矩阵的传递？？**  边缘化的操作
  
+ 
  
  
  
  
  
  
  
  ​																																															
  
  

________

## 对vins-fusion 要做的

+ 加入线的三角化函数（前后与左右），结构化特性      考虑可视化的问题
+ pnp时，考虑纳入结构化线特征
+ 优化函数，融入结构化线特征
+ 关键在optimization()函数
+ **当用实时运行时，每个数据都会去做处理嘛？**
+ **点的三角化，**
  + 前后三角化时，仅使用了start_frame帧与下一帧，直接三角化，————相当与仅用最**开始观测的两帧**，进行三角化
  + 最终存储的为在start_frame相机坐标系下的深度
+ vins-fusion中，先从原始图像中提取出特征点后，再对提取出的像素坐标系下的特征点进行畸变矫正
+ vins中，并不对特征点做直接的双目极线对齐，而是当成两个已知相机位资下的观测，使用的是相机的旋转平移位资，而非简单的一根极线（仅使用一根极线，须极线对齐）
+ 

_______

## 流程的处理

### 特征发布

+ 将rosbag中的消息先全放入buffer内，再从buffer中取出数据进行处理，发送特征

之前的 estimator_node节点

+ 订阅点线特征的话题，回调函数，将消息存入buffer
+ 将全部的imu消息从rosbag中拿出，全部存入buffer内
+ process（）函数内，一直循环处理
  + 数据时间戳的对齐，获得一次测量measurement，包含了imu的测量，点线特征
  + 先处理imu的测量，
  + 再点线特征，处理视觉测量**estimator.processImage();**
  + 发布里程计等结果

### vins-fusion的处理

+ 订阅话题，回调函数将相应的消息存入buffer内
+ 并行的线程processMeasurements，只要特征featureBuf不为空，一直循环处理测量
  + 取出imu的数据，进行imu的处理
  + **processImage（）**处理一帧图像提取出来的特征点，
+ sync_process（）函数内，一直循环处理
  + 从buffer中拿出一对图片，得到特征点后，又放入特征buffer内，
+   std::thread sync_thread{sync_process};
      ros::spin();
  + ros::spin(); spin是，主线程一直循环执行接收消息的回调函数
  + sync_process函数被开辟了另一个线程去执行

____



## 陷入局部细节中，仍然没有接近核心的东西

 ## 核心

+ 

一直在改双目，





_______



## 2.2

+ 起床后，洗漱，笔记本上记的内容看一下，迅速会议         臭蛋看动画片
+ 饭后，，口琴与看书半个小时，回想代码细节，想起放假前的工作，       臭蛋  先写会作业，，让去电视上看纪录片 ，并写出读后感
+ 晚饭后，半个小时口琴与看书，，继续推进工作     臭蛋

## 2.3 

NOll

##　2.4　

对接完成

## 2.5

+ VINS的编译，设法看能不能编译　　早
+ 考虑双目线特征，
+ 搞清楚优化函数，

## 2.9

晚上才解决了筛选后线特征的描述子提取

## 2.10

务必解决线双目

+ 左右并行提取特征
+ 计算双目匹配
  + 极线的约束，右目的匹配点，描述子距离最小的
+ vins中，右目的特征都是基于与左目匹配上的，左目的的匹配，
+ vins中，addFeatureCheckParallax（）函数内，构建featureperID时，会判断特征点是否有右目观测，若有，三角化时左右目三角化，若没有，则采用前后帧三角化
+ 原vins中，在从图像中提取点特征时，没有对图像的矫正，，矫正暂时用的左目的
+ 将match理解为两者的匹配关系描述
+ 

## 明天务必与梁馨月番茄闹钟APP

## 2.29

1. 单线程，非实时
   1. 直接读取line的rosbag，图片与ｉｍｕ读进去，
   2. 获取对其的line,图片，图片处理点特征，再与ｉｍｕ对齐，，串行处理，不要并行多线程，加入gdb看效果
2. 线的基本处理，三角化

## 3.11

1. 结构化线的处理
2. 坐标系与主方向————坐标关系

____________________

_______________

## 在这些地方卡住了

###　１．数据的对齐————锁死问题————多线程的的协调，，gdb影响了多线程的运行

2. 由于线的误匹配，同一帧会出现多条id相同的线，导致线特征的观测数量出现异常。最后，在填入FeaturePerId时，进行检测，暂时回避该问题    -----根本的解决，线特征的匹配
3. 结构线分类出错
4. 滑窗对特征的处理
5. MEI相机模型    在mei相机模型下，得不到矫正的图像，，，继续采用针孔模型，，原版的PLVIO就是针孔模型，点特征的处理与vins一致，也是不对原图去畸变，只对提取的特征点进行去畸变，，，线特征采用针孔模型矫正的图像数据，，现暂时沿用此方案——————纠结了3天，，没球用
6. 

ubuntu



