__________

# 该部分基本解决

## 线的提取及匹配部分的遗留问题

1. 出现id相同的线的处理，目前把这种情况给删了，导致后续出现的额外的问题，所以，应该让线在帧间的观测连续。
2. 考虑线的合并，同一条线，被隔帧检测到，变会成为一个新的线，可合并的线很多
3. **改进**————右目的线按结构化分类，与同类别的左目去匹配，适当提高匹配阈值，增加匹配数量

### 匹配的问题还是有些多

+ 判断条件，距离，角度差，像素梯度
+ 每个参数都是应该推敲的

### 右目也有LBD描述子，更多可匹配的途径？

+ 单纯的匹配也就耗时2~3ms而已，
+ 正反双向匹配，得到前后一一对应的匹配对，逆向匹配得到的ID，只有判断与最初的一致，双目情况下，才发送右目观测，，如果是前后匹配，不一致情况下，让最新帧那个相应的id重新置为-1，表示该帧并没有匹配
+ 解决完一一对应匹配问题，还是优先解决线的合并问题

## 线的合并

+ 首先通过三维空间距离判断，再由2d平面的观测，以及观测帧的顺序，去判断是否合并线特征
+ 发现仅将优化过后线再去考虑做合并，效果差于最开始的



__________________



## ideal  像滑窗一样去匹配线特征，最新帧与窗口内的各帧去做匹配

______



## 同一副图上，属于同一条直线的线特征的合并

可能涉及LBD描述子的合并，先合并线特征，再计算描述子



________



## 线的三角化及其相关

1. 滑窗时，将三角化的线转到另一个帧时，考虑该帧上是否有该线的观测, **该问题可从线的提取部分，得到彻底解决，提取的线特征是帧间连续的**—————利用的只是该帧的Rcs，即使该帧没有观测，也无影响，倘若非要转到有观测的那个帧，还反倒少了一个观测的约束
2. **三角化所在帧的观测约束不会进入优化，浪费掉了一次观测约束**，可以在这里在定义一种参差函数，专门处理该情况——已尝试，效果差
3. 点特征，基于9帧三角化的结果，没有做任何处理，直接放到了10帧，可能带来误差，但影响不大？，**值得验证**——实际验证发现，不做任何处理的效果最好rmse	0.034113。分别尝试让其在10帧重新三角化与将9帧点的深度转换到10帧，结果分别为 rmse	0.036037   与  rmse	0.035037  
4. 应该将所有的start_frame换为In_frame_count ——————**-改了，发现影响不大**
5. 结构线三角化的方式，有待改进之处？
6. 滑窗时，三角化的线在帧间的转移，目前与初始三角化所用的方法是一样的
7. 滑窗时，feature_mange.cpp   975行左右的问题
8. 为啥会在相机运动所在的平面有那么多的线，，实际上，轨迹周围是没有线的———因为双目直接三角化的线，很多有问题，而这些线，由于观测少，没有进入优化框架
9. 后续可以考虑将相关的外参固定下来，减少优化变量，提升优化效率
10. **三角化时，通过点线距离筛选，发现有问题，之前的点线距离公式计算有误**————暂时改为通过直线的端点筛选

______

## 优化

1. 可以考虑把Rcs作为一个观测，观测的话，得考虑协方差
2. 表现在Rws上，窗口内某帧的角度为何会变坏，**Rcs是固定的，突然变坏，出问题的就是Rwc**， **考虑，当该位姿所受的约束最多的时候，其优化的结果最接近真相？？** ——可以统计一下待优化节点受到的约束个数
3. 位姿的输出，是最新进的帧。但是，最新进的帧，只是作为被动观测帧，其上三角化的特征并未进入优化，所以，问题处在三角化？实际发现，容易出错的帧，在窗口比较靠后的位置？
4. 三角化所在帧的观测，可以考虑右目观测，目前是直接跳过的，因为参数不能重复
   1. 针对三角化所在帧，添加了优化函数，在该帧只优化线的参数，但效果大为变差，整体运行的时间却大为减少，90多秒
   2. 一个可能的原因是，三角化所在帧的Rs可能出现异常，将结构线转到0帧时，出现问题，————但是，尝试过当只有三角化所在帧的Rws是没出问题的时候，才建立单帧观测约束，但结果与上面的一样，丝毫不差，误差极大
5. 非线性优化部分，使用imu预测相机位姿
6. **点线在视觉优化中各占的比重？，线对整个优化的影响程度**
7. 做优化时，imu_i,是三角化所在的帧，而边缘化时，imu_i却是start_frame??边缘化时，可以考虑把0帧有观测，但却不是在0帧三角化的帧转到0帧——当marge最老帧的时候，尝试过将不是在0帧上三角化的结果转到0帧，结果发现效果没有变好



1. 联合优化前，要不要单独优化线，优化过程中要不要固定相关的参数，应该实验检验，以确定最佳的效果

______

## 边缘化

1. 当要marge最老帧，该帧上观测到的特征就是要处理的，观测就是约束，与在哪个帧上三角化没有关系，而是哪个帧对该特征有约束（观测），这才是关键————但是，假如该特征是在0帧上三角化的，但事实上，0帧作为一个三角化的基础帧，没有观测约束，优化的时候，并没有添加0帧的观测

_________

## 合并Rcs（合并曼哈顿世界）

+ 当前的做法是，根本没有合并Rcs，只是将Rcs作为一个帧下结构线的方向，没有考虑优化，没有合并



世界系一个理论的Rws，在再根据相机的位姿Rwc，可以得到一个理论的Rcs（理论值），可以转换成消失点表示，而实际的消失点就认为是观测值，从而建立理论只与观测值的误差，



## 	方向使用统一的Rws

但仍然有两种做法

1. 所有的线基于那个在世界系下唯一的S系，
   1. 建立结构线的模型时，是从世界系下的点出发，与结构线相关的状态量全是基于世界系的，与三角化所在的帧无关系了
2. 线仍然基于相机帧下的S系，但方向统一，原点就是相机原点
   1. 和最初的方案接近，还是从相机系的点出发，基于三角化所在帧

_________

## 有影响的参数统计

1. LBD描述子匹配的阈值   MATCHES_DIST_THRESHOLD  
2. 通过线段端点距离筛选直线还是线段中点距离筛选，以及相应的阈值
3. 线合并的检测阈值，包括3d空间下的直线的距离，2d归一化平面上观测直线的距离
4. 判断直线的三角化是否正确的检测阈值
5. 